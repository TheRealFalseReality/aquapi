<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaPi Assistant</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for the Inter font family -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }
        /* Custom scrollbar for chat history */
        #chat-history {
            overflow-y: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        #chat-history::-webkit-scrollbar {
            display: none;
        }
        /* Styling for the custom toggle switch for units */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .toggle-switch-container .label {
            margin-right: 0.5rem;
            font-weight: 500;
            color: #4b5563;
        }
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        .toggle-switch-label {
            cursor: pointer;
            text-indent: -9999px;
            width: 50px;
            height: 26px;
            background: #9ca3af;
            display: block;
            border-radius: 100px;
            position: relative;
            transition: background-color 0.2s ease;
        }
        .toggle-switch-label:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 90px;
            transition: 0.2s;
        }
        .toggle-switch input[type="checkbox"]:checked + .toggle-switch-label {
            background: #2563eb;
        }
        .toggle-switch input[type="checkbox"]:checked + .toggle-switch-label:after {
            left: calc(100% - 2px);
            transform: translateX(-100%);
        }
        /* CSS for the fade effect */
        #chat-lightbox {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #chat-lightbox.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen bg-gray-100 p-4">
    <div class="flex flex-col items-center justify-center">
        <!-- New marketing text block -->
        <div class="text-center max-w-md mb-6 p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Aquarium Care, Simplified.</h2>
            <p class="text-gray-600">Get instant expert advice, analyze your water parameters, and learn how to automate your tank with AquaPi. Start a conversation now to transform your aquarium care routine.</p>
        </div>
        <!-- Button to open the chat window -->
        <button id="open-chat-button" class="flex items-center justify-center p-4 bg-blue-600 text-white rounded-lg shadow-xl hover:bg-blue-700 transition duration-200">
            <img src="https://github.com/TheRealFalseReality/aquapi/blob/main/assets/image/AquaPiLogo150px.png?raw=true" alt="AquaPi Logo" class="w-8 h-8 object-contain mr-3">
            <span class="text-xl font-bold">AquaPi Assistant</span>
        </button>
    </div>
    
    <!-- Chat Lightbox Overlay -->
    <div id="chat-lightbox" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div id="chat-container" class="flex flex-col bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-3xl h-full sm:max-w-4xl lg:max-w-5xl xl:max-w-6xl">
            <!-- Chat Header -->
            <div class="flex items-center justify-between p-4 bg-gray-800 text-white rounded-t-lg shadow-md">
                <div class="flex items-center">
                    <!-- AquaPi logo -->
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden">
                        <img src="https://github.com/TheRealFalseReality/aquapi/blob/main/assets/image/AquaPiLogo150px.png?raw=true" alt="AquaPi Logo" class="w-8 h-8 object-contain">
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-bold">AquaPi Assistant</h1>
                        <p class="text-xs text-gray-300">Online</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <!-- Version number moved inside the chat header -->
                    <div id="chat-version-number" class="p-2 text-right text-xs text-gray-500">
                        Version: 25.8.1.7
                    </div>
                    <!-- Close Button for the Lightbox -->
                    <button id="close-chat-button" class="text-gray-400 hover:text-white transition duration-200 ml-2">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 p-4 space-y-4">
                <!-- Initial bot greeting will be inserted here by JavaScript -->
            </div>

            <!-- AI Feature and User Input Area -->
            <div class="p-4 bg-gray-50 border-t border-gray-200">
                <!-- Collapsible suggestions drawer -->
                <div class="mb-4">
                    <button id="suggested-questions-toggle" class="w-full p-2 bg-gray-200 text-gray-800 rounded-lg shadow-md hover:bg-gray-300 transition duration-200 font-semibold text-sm flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas fa-comment-dots mr-2"></i>
                            Ask or Analyze
                        </span>
                        <i id="toggle-icon" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="suggested-questions-container" class="hidden overflow-hidden transition-all duration-300">
                        <div class="mt-2 flex flex-wrap justify-center gap-2 pb-2">
                            <button id="suggested-question-button-1" class="flex-1 p-3 bg-blue-100 text-blue-600 rounded-lg shadow-md hover:bg-blue-200 transition duration-200">What is AquaPi?</button>
                            <button id="suggested-question-button-2" class="flex-1 p-3 bg-blue-100 text-blue-600 rounded-lg shadow-md hover:bg-blue-200 transition duration-200">Compare AquaPi to Apex Neptune</button>
                            <button id="suggested-question-button-3" class="flex-1 p-3 bg-blue-100 text-blue-600 rounded-lg shadow-md hover:bg-blue-200 transition duration-200">What parameters can AquaPi monitor?</button>
                            <button id="suggested-question-button-4" class="flex-1 p-3 bg-blue-100 text-blue-600 rounded-lg shadow-md hover:bg-blue-200 transition duration-200">Can I use my own sensors?</button>
                            <button id="analyze-button-drawer" class="flex-1 p-3 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-200">
                                Analyze Water Parameters ✨
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Water analysis input form -->
                <div id="analysis-form" class="hidden space-y-2 mb-4 p-4 bg-gray-100 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-semibold text-gray-700">Water Parameters</h4>
                        <button id="close-analysis-form" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" id="tank-type-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Freshwater Community, Reef Tank">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="temp-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Temperature in °F">
                        <div class="toggle-switch-container m-0">
                            <span class="label text-sm" id="temp-unit-label">Fahrenheit (°F)</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="unit-toggle" name="unit-toggle" checked>
                                <label class="toggle-switch-label" for="unit-toggle"></label>
                            </div>
                        </div>
                    </div>
                    <input type="text" id="ph-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="pH value (optional)">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="salinity-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Salinity (ppt) or leave blank for freshwater">
                        <div class="toggle-switch-container m-0">
                            <span class="label text-sm" id="salinity-unit-label">ppt</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="salinity-unit-toggle" name="salinity-unit-toggle">
                                <label class="toggle-switch-label" for="salinity-unit-toggle"></label>
                            </div>
                        </div>
                    </div>
                    <textarea id="additional-info-input" class="w-full p-2 border border-gray-300 rounded-lg resize-none" rows="3" placeholder="Any other details about your tank? (e.g., livestock, recent changes, issues)"></textarea>
                    <button id="submit-analysis" class="w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">Submit for Analysis</button>
                </div>

                <!-- Standard chat input -->
                <div id="user-input-container" class="flex items-center">
                    <input type="text" id="user-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Ask me about AquaPi...">
                    <button id="send-button" class="ml-3 p-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Version number moved to the bottom right of the body -->
    <div id="version-number-main" class="fixed bottom-2 right-2 text-right text-xs text-gray-500">
        Version: 25.8.1.7
    </div>

    <script>
        // Get DOM elements
        const chatHistoryElement = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const analyzeButtonDrawer = document.getElementById('analyze-button-drawer');
        const analysisForm = document.getElementById('analysis-form');
        const submitAnalysisButton = document.getElementById('submit-analysis');
        const tankTypeInput = document.getElementById('tank-type-input');
        const phInput = document.getElementById('ph-input');
        const tempInput = document.getElementById('temp-input');
        const salinityInput = document.getElementById('salinity-input');
        const unitToggle = document.getElementById('unit-toggle');
        const tempUnitLabel = document.getElementById('temp-unit-label');
        const userInputContainer = document.getElementById('user-input-container');
        const additionalInfoInput = document.getElementById('additional-info-input');
        const salinityUnitToggle = document.getElementById('salinity-unit-toggle');
        const salinityUnitLabel = document.getElementById('salinity-unit-label');
        const openChatButton = document.getElementById('open-chat-button');
        const closeChatButton = document.getElementById('close-chat-button');
        const chatLightbox = document.getElementById('chat-lightbox');
        const suggestedQuestionsContainer = document.getElementById('suggested-questions-container');
        const suggestedQuestionsToggle = document.getElementById('suggested-questions-toggle');
        const toggleIcon = document.getElementById('toggle-icon');
        const closeAnalysisFormButton = document.getElementById('close-analysis-form');
        const suggestedQuestionButton1 = document.getElementById('suggested-question-button-1');
        const suggestedQuestionButton2 = document.getElementById('suggested-question-button-2');
        const suggestedQuestionButton3 = document.getElementById('suggested-question-button-3');
        const suggestedQuestionButton4 = document.getElementById('suggested-question-button-4');
        const chatVersionNumber = document.getElementById('chat-version-number');
        const mainVersionNumber = document.getElementById('version-number-main');


        let conversationHistory = []; // Stores the full conversation history
        let tempUnit = 'F'; // Default to Fahrenheit
        let salinityUnit = 'ppt'; // New state variable for salinity unit
        const API_KEY = "AIzaSyC_LqNFttcJ_0jhA-GM9bgWgsPJ2TImSuk"; // Canvas will automatically provide the API key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;


        // Persona prompt to give the AI context. This is prepended to the first user message.
        const personaPrompt = `You are AquaPi, an AI assistant for the AquaPi aquarium monitoring and automation system. Your purpose is to help users understand and use the system.
        
        Guidelines for your responses:
        - Maintain a friendly, informative, and encouraging tone.
        - Explain features like water parameter monitoring, real-time notifications, and automation.
        - Detail the included sensors: temperature, optical water level, water leak, pH, conductivity (salinity), ORP, peristaltic dosing pump, and gaseous carbon dioxide.
        - Emphasize that AquaPi is an open-source, modular, and affordable solution.
        - Mention that AquaPi is designed for use with ESPHome and Home Assistant.
        - Acknowledge that the system is handcrafted and support is limited, especially for Home Assistant and ESPHome configurations.
        - Encourage users to share their customizations.
        - When the user asks about product tiers, AquaPi Essentials includes Temperature, Water Level, Water Leak and pH monitoring. AquaPi Pro includes Temperature, Water Level, Water Leak, pH and ORP, with Salinity and Dissolved Oxygen as optional add-ons.
        - Do not mention the files you were trained on. Just use the information from them.
        - Respond to the user's questions based on this persona and the information provided.
        - Keep your responses to 2-4 paragraphs. Ensure the formatting is easy to read. Use simple, direct language in plain text.
        - Do not act like a generic assistant. You are AquaPi.
        - Always link to AquaPi in some way. Describe how AquaPi can help the user or find ways to fix problems and find solutions.
        - When a user asks about a specific sensor or sensors, mention the ones AquaPi supports (temperature, optical water level, water leak, pH, conductivity/salinity, ORP, peristaltic dosing pump, and gaseous carbon dioxide) and briefly describe their capabilities. Keep the descriptions concise and easy to understand.
        - When a user asks a generic aquarium question, first provide a general, expert answer. Then, link the issue back to AquaPi, explaining how our sensors (as well as the sensors that the product supports) and automation capabilities could help them monitor and address the problem.
        - All responses must be formatted using Markdown for clarity. Use headings (e.g., "### Heading"), bullet points for lists (\`- List item\`), and bold text (\`**important**\`) to make the information easy to scan and read. When creating lists, ensure there is a line break between each list item to improve readability. Add a line break between each paragraph.`;

        // A simple Markdown-to-HTML parser for basic formatting
        function parseMarkdown(text) {
            let html = text;

            // Replace headings
            html = html.replace(/^# (.*?)(\n|$)/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.*?)(\n|$)/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.*?)(\n|$)/gm, '<h3>$1</h3>');
            html = html.replace(/^#### (.*?)(\n|$)/gm, '<h4>$1</h4>');
            html = html.replace(/^##### (.*?)(\n|$)/gm, '<h5>$1</h5>');
            html = html.replace(/^###### (.*?)(\n|$)/gm, '<h6>$1</h6>');

            // Replace bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Replace list items and wrap in <ul> tags
            const listRegex = /^(- .*(\n- .*)*)/gm;
            html = html.replace(listRegex, (match) => {
                const listItems = match.split('\n').map(item => `<li>${item.substring(2)}</li>`).join('');
                return `<ul>${listItems}</ul>`;
            });
            
            // Replace double newlines with paragraph breaks
            html = html.replace(/\n\n/g, '<br><br>');
            // Replace single newlines with simple line breaks, but only if they are not inside list items
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Function to display a message in the chat history
        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow-md ${
                sender === 'user'
                    ? 'bg-blue-600 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            }`;
            // Use the new Markdown parser for bot messages
            if (sender === 'bot') {
                messageBubble.innerHTML = parseMarkdown(text);
            } else {
                messageBubble.innerHTML = text;
            }
            messageDiv.appendChild(messageBubble);
            chatHistoryElement.appendChild(messageDiv);
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }

        // Handles the new AI water analysis feature
        async function analyzeWaterParameters(tankType, ph, temp, salinity, additionalInfo) {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'flex justify-start';
            loadingIndicator.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl rounded-bl-none shadow-md bg-gray-200 text-gray-800">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
            chatHistoryElement.appendChild(loadingIndicator);
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;

            // Convert to Celsius if the user entered Fahrenheit
            let tempForAnalysis = temp;
            if (tempUnit === 'F') {
                tempForAnalysis = ((temp - 32) * 5/9).toFixed(2); // Keep two decimal places for precision
            }

            // Determine the salinity unit for the prompt
            const salinityUnitText = salinityUnit === 'ppt' ? 'ppt' : 'Specific Gravity (SG)';

            const analysisPrompt = `Act as an aquarium expert. Analyze the following water parameters for a ${tankType} aquarium:
            ${ph ? `- pH: ${ph}` : ''}
            - Temperature: ${tempForAnalysis}°C
            ${salinity ? `- Salinity: ${salinity} ${salinityUnitText}` : ''}
            ${additionalInfo ? '- Additional Information: ' + additionalInfo : ''}
            
            Provide a detailed but easy-to-understand analysis. Explain what each parameter means, what the ideal range is for this type of tank, and what the user should do if their values are out of range. Also, suggest how AquaPi's sensors can help them monitor these values continuously. Be concise and to the point. Format your response with Markdown using headings, bold text, and lists.`;
            
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: analysisPrompt }] }] };
                let response;
                let text = "I'm sorry, I seem to be having trouble processing that request right now. Please try again later.";
                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                text = result.candidates[0].content.parts[0].text;
                            }
                            break;
                        } else if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        } else {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                    } catch (e) {
                        console.error("API call failed:", e);
                        if (i === maxRetries - 1) {
                            throw e;
                        }
                    }
                }
                
                conversationHistory.push({ role: "model", parts: [{ text: text }] });
                displayMessage(text, 'bot');
            } catch (error) {
                console.error("Error fetching analysis:", error);
                displayMessage("Sorry, I'm having trouble analyzing your parameters right now. Please try again later.", 'bot');
            } finally {
                if (loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
            }
        }

        // Handles the regular chat messages
        async function getBotResponse() {
            // Placeholder for loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'flex justify-start';
            loadingIndicator.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl rounded-bl-none shadow-md bg-gray-200 text-gray-800">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
            chatHistoryElement.appendChild(loadingIndicator);
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;

            try {
                // Prepend the persona prompt to the first user message
                const contents = conversationHistory.map(entry => {
                    const text = entry.role === 'user' && conversationHistory.indexOf(entry) === 0
                        ? personaPrompt + "\n\n" + entry.parts[0].text
                        : entry.parts[0].text;
                    return { role: entry.role, parts: [{ text: text }] };
                });

                const payload = {
                    contents: contents
                };
                
                let response;
                let text = "I'm sorry, I seem to be having trouble processing that request right now. Please try again later.";
                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                text = result.candidates[0].content.parts[0].text;
                            }
                            break;
                        } else if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        } else {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                    } catch (e) {
                        console.error("API call failed:", e);
                        if (i === maxRetries - 1) {
                            throw e;
                        }
                    }
                }
                
                conversationHistory.push({ role: "model", parts: [{ text: text }] });
                displayMessage(text, 'bot');

            } catch (error) {
                console.error("Error fetching bot response:", error);
                displayMessage("Sorry, I'm having trouble connecting right now. Please try again later.", 'bot');
            } finally {
                // Ensure the loading indicator is always removed
                if (loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
            }
        }

        // Handle sending messages
        async function handleChatSubmission() {
            const message = userInput.value.trim();
            if (message) {
                displayMessage(message, 'user');
                conversationHistory.push({ role: "user", parts: [{ text: message }] });
                userInput.value = '';
                await getBotResponse();
            }
        }
        
        // Event listeners for sending messages with a click or pressing Enter
        sendButton.addEventListener('click', handleChatSubmission);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleChatSubmission();
            }
        });

        // Event listener for the new analysis feature button
        const analyzeButton = document.getElementById('analyze-button-drawer'); // Using the new ID
        analyzeButton.addEventListener('click', () => {
            analysisForm.classList.toggle('hidden');
            const isHidden = analysisForm.classList.contains('hidden');
            
            if (isHidden) {
                // If form is now hidden, un-hide the other UI elements
                suggestedQuestionsContainer.classList.remove('hidden');
                toggleIcon.classList.remove('rotate-180');
                suggestedQuestionsToggle.classList.remove('hidden');
                userInputContainer.classList.remove('hidden');
            } else {
                // If form is now visible, hide the other UI elements
                suggestedQuestionsContainer.classList.add('hidden');
                toggleIcon.classList.add('rotate-180');
                suggestedQuestionsToggle.classList.add('hidden');
                userInputContainer.classList.add('hidden');
            }
        });

        // Event listener for closing the analysis form
        closeAnalysisFormButton.addEventListener('click', () => {
            analysisForm.classList.add('hidden');
            suggestedQuestionsContainer.classList.remove('hidden');
            toggleIcon.classList.remove('rotate-180');
            suggestedQuestionsToggle.classList.remove('hidden');
            userInputContainer.classList.remove('hidden'); // Ensure the user input field is visible
        });

        // Event listener for the temperature unit toggle switch
        unitToggle.addEventListener('change', () => {
            if (unitToggle.checked) {
                tempUnit = 'F';
                tempInput.placeholder = 'Temperature in °F';
            } else {
                tempUnit = 'C';
                tempInput.placeholder = 'Temperature in °C';
            }
            tempUnitLabel.textContent = unitToggle.checked ? 'Fahrenheit (°F)' : 'Celsius (°C)';
        });

        // New event listener for the salinity unit toggle switch
        salinityUnitToggle.addEventListener('change', () => {
            if (salinityUnitToggle.checked) {
                salinityUnit = 'SG';
                salinityInput.placeholder = 'Salinity (SG) or leave blank for freshwater';
                salinityUnitLabel.textContent = 'SG';
            } else {
                salinityUnit = 'ppt';
                salinityInput.placeholder = 'Salinity (ppt) or leave blank for freshwater';
                salinityUnitLabel.textContent = 'ppt';
            }
        });

        submitAnalysisButton.addEventListener('click', async () => {
            const tankType = tankTypeInput.value;
            const ph = phInput.value;
            const temp = tempInput.value;
            const salinity = salinityInput.value;
            const additionalInfo = additionalInfoInput.value;

            if (tankType && temp) {
                const salinityUnitText = salinityUnit === 'ppt' ? 'ppt' : 'SG';
                
                // Construct the user message with conditional pH value
                const phMessage = ph.trim() !== '' ? `, pH: ${ph}` : '';
                const userMessage = `Please analyze my water parameters for my ${tankType} tank. Temp: ${temp}°${tempUnit}${phMessage}${salinity ? `, Salinity: ${salinity} ${salinityUnitText}` : ''}${additionalInfo ? `, Additional Info: ${additionalInfo}` : ''}.`;

                displayMessage(userMessage, 'user');

                // Hide the form and restore the user input field immediately
                analysisForm.classList.add('hidden');
                userInputContainer.classList.remove('hidden');
                
                // Pass the new info to the analysis function
                await analyzeWaterParameters(tankType, ph, temp, salinity, additionalInfo);
            } else {
                // This is a modal-like alert that's better than window.alert
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center">
                        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                            <h3 class="text-lg font-bold mb-4">Missing Information</h3>
                            <p>Please fill in all required fields: Tank Type and Temperature.</p>
                            <button id="close-message" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
                document.getElementById('close-message').addEventListener('click', () => {
                    document.body.removeChild(messageBox);
                });
            }
        });

        // Event listeners for the lightbox
        openChatButton.addEventListener('click', () => {
            chatLightbox.classList.remove('hidden');
            // This small delay ensures the transition effect works correctly
            setTimeout(() => {
                chatLightbox.classList.add('visible');
            }, 10);
            
            // Hide version number on the main screen
            mainVersionNumber.classList.add('hidden');

            // Re-initialize the welcome message
            if (conversationHistory.length === 0) {
                const initialMessage = "# Welcome to AquaPi!\n\nI'm your friendly AI assistant, here to help you get the most out of our open-source aquarium monitoring system.\n\nTo get started, please tell me a bit about your setup:\n\n- What kind of aquarium do you have? (e.g., freshwater, reef)\n- What are your monitoring and automation goals?\n- Are you familiar with ESPHome and Home Assistant?\n\nDon't forget to check out our new ✨ AI Water Analysis feature!";
                conversationHistory.push({ role: "model", parts: [{ text: initialMessage }] });
                displayMessage(initialMessage, 'bot');
            }
        });

        closeChatButton.addEventListener('click', () => {
            chatLightbox.classList.remove('visible');
            // Wait for the transition to finish before hiding the element completely
            setTimeout(() => {
                chatLightbox.classList.add('hidden');
            }, 300);
            // Show version number on the main screen
            mainVersionNumber.classList.remove('hidden');
        });
        
        // Event listener to close the lightbox when clicking outside the chat container
        chatLightbox.addEventListener('click', (event) => {
            if (event.target === chatLightbox) {
                chatLightbox.classList.remove('visible');
                // Wait for the transition to finish before hiding the element completely
                setTimeout(() => {
                    chatLightbox.classList.add('hidden');
                }, 300);
                // Show version number on the main screen
                mainVersionNumber.classList.remove('hidden');
            }
        });

        // Add scroll functionality
        openChatButton.addEventListener('click', () => {
          // scroll down 5% of the window's height
          window.scrollBy(0, window.innerHeight * 0.05);
        });
        
        // Event listener for the suggested question buttons
        suggestedQuestionButton1.addEventListener('click', async () => {
            const question = suggestedQuestionButton1.textContent.trim();
            userInput.value = question;
            // Close the drawer immediately
            suggestedQuestionsContainer.classList.add('hidden');
            toggleIcon.classList.remove('rotate-180');
            await handleChatSubmission();
        });
        suggestedQuestionButton2.addEventListener('click', async () => {
            const question = suggestedQuestionButton2.textContent.trim();
            userInput.value = question;
            // Close the drawer immediately
            suggestedQuestionsContainer.classList.add('hidden');
            toggleIcon.classList.remove('rotate-180');
            await handleChatSubmission();
        });
        suggestedQuestionButton3.addEventListener('click', async () => {
            const question = suggestedQuestionButton3.textContent.trim();
            userInput.value = question;
            // Close the drawer immediately
            suggestedQuestionsContainer.classList.add('hidden');
            toggleIcon.classList.remove('rotate-180');
            await handleChatSubmission();
        });
        suggestedQuestionButton4.addEventListener('click', async () => {
            const question = suggestedQuestionButton4.textContent.trim();
            userInput.value = question;
            // Close the drawer immediately
            suggestedQuestionsContainer.classList.add('hidden');
            toggleIcon.classList.remove('rotate-180');
            await handleChatSubmission();
        });
        
        // New event listener for the suggestions toggle button
        suggestedQuestionsToggle.addEventListener('click', () => {
            suggestedQuestionsContainer.classList.toggle('hidden');
            toggleIcon.classList.toggle('rotate-180');
        });

        // Initial greeting from the bot - now only displayed when the lightbox is opened
        window.onload = function() {
            // No initial message on page load, waiting for button click
        };
    </script>
</body>
</html>
